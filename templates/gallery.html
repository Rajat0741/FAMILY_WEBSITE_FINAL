{% extends "base.html" %}

{% block title %}Gallery | Family Gallery{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">{{ current_folder.name }}</h1>

        <div class="flex flex-wrap gap-3">
            <button id="uploadBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center">
                <i class="fas fa-upload mr-2"></i>
                Upload Media
            </button>

            {% if is_admin %}
            <a href="{{ url_for('admin_settings') }}" id="manageBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center">
                <i class="fas fa-cog mr-2"></i>
                Admin Settings
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Breadcrumb navigation -->
    <div class="flex flex-wrap items-center text-gray-600 mb-4 bg-white p-3 rounded-lg shadow-sm">
        {% for crumb in breadcrumbs %}
            {% if loop.last %}
                <span class="font-medium text-indigo-800">{{ crumb.name }}</span>
            {% else %}
                <a href="{{ url_for('gallery', folder_id=crumb.id) }}" class="hover:text-indigo-600 transition duration-300">
                    {{ crumb.name }}
                </a>
                <span class="mx-2">/</span>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Search and filter -->
    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-lg shadow mb-6">
        <div class="relative w-full md:w-64 mb-4 md:mb-0">
            <input type="text" placeholder="Search media..." 
                   class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
            <div class="absolute left-3 top-2.5 text-gray-400">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <div class="flex items-center space-x-3">
            <select class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <option value="all">All Media</option>
                <option value="images">Images</option>
                <option value="videos">Videos</option>
            </select>

            <select class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="a-z">A-Z</option>
                <option value="z-a">Z-A</option>
            </select>
        </div>
    </div>
</div>

<!-- Folders Grid -->
{% if subfolders %}
<div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Folders</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
        {% for folder_id, folder in subfolders.items() %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden group">
            <a href="{{ url_for('gallery', folder_id=folder_id) }}" class="block p-4">
                <div class="flex items-center justify-center mb-3">
                    <i class="fas fa-folder text-4xl text-yellow-400"></i>
                </div>
                <p class="text-center text-gray-800 font-medium truncate">{{ folder.name }}</p>
            </a>
            {% if is_admin %}
            <div class="bg-gray-100 p-2 flex justify-center">
                <form method="POST" action="{{ url_for('delete_folder', folder_id=folder_id) }}" onsubmit="return confirm('Are you sure you want to delete this folder? This cannot be undone.');">
                    <button type="submit" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash-alt mr-1"></i> Delete
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Gallery grid -->
<div>
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Media</h2>

    {% if media %}
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-8">
        {% for media_id, item in media.items() %}
        <div class="relative bg-white rounded-lg shadow-md overflow-hidden group">
            <a href="{{ url_for('view_media', file_id=media_id) }}" class="block">
                <div class="aspect-w-1 aspect-h-1 bg-gray-200">
                    {% if item.type == 'video' %}
                    <div class="w-full h-0 pt-[100%] bg-gray-300 flex items-center justify-center relative">
                        <i class="fas fa-video absolute text-4xl text-gray-500"></i>
                        <span class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded-md text-xs">VIDEO</span>
                    </div>
                    {% else %}
                    <div class="w-full h-0 pt-[100%] relative overflow-hidden">
                        <img src="{{ url_for('get_thumbnail', file_id=media_id) }}" alt="{{ item.name }}" 
                             class="absolute inset-0 w-full h-full object-cover" 
                             loading="lazy"
                             onerror="this.onerror=null; this.src='{{ url_for('placeholder_image') }}'; console.error('Failed to load thumbnail for: {{ media_id }}');">
                    </div>
                    {% endif %}
                </div>
            </a>
            <div class="p-2 text-gray-800 truncate text-sm">{{ item.name }}</div>
            <div class="absolute top-0 left-0 w-full h-full bg-black bg-opacity-0 group-hover:bg-opacity-40 transition duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
                <div class="flex space-x-2">
                    <a href="{{ url_for('view_media', file_id=media_id) }}" class="bg-white p-2 rounded-full text-gray-800 hover:bg-gray-200 transition duration-300">
                        <i class="fas fa-expand"></i>
                    </a>
                    <a href="{{ url_for('download_media', file_id=media_id) }}" class="bg-white p-2 rounded-full text-gray-800 hover:bg-gray-200 transition duration-300">
                        <i class="fas fa-download"></i>
                    </a>
                    {% if is_admin %}
                    <form method="POST" action="{{ url_for('delete_media', file_id=media_id) }}" onsubmit="return confirm('Are you sure you want to delete this media file? This cannot be undone.');">
                        <input type="hidden" name="folder_id" value="{{ folder_id }}">
                        <button type="submit" class="bg-white p-2 rounded-full text-red-600 hover:bg-red-100 transition duration-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white p-8 rounded-lg shadow text-center">
        {% if subfolders %}
        <p class="text-gray-600">No media in this folder. Upload media or navigate to a different folder.</p>
        {% else %}
        <p class="text-gray-600 mb-4">This folder is empty. Upload media or create subfolders.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Upload Modal (hidden by default) -->
<div id="uploadModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-5 border-b">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Upload Media</h3>
                <button id="closeUploadModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-5">
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" name="folder_id" value="{{ folder_id }}">
                <input type="hidden" name="upload_id" id="uploadIdField" value="">
                
                <!-- Drag and drop zone -->
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 mb-4 text-center cursor-pointer hover:bg-gray-50 transition">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 mb-2">Drag files here or click to select</p>
                    <p class="text-gray-500 text-xs">Supported formats: Images (JPG, PNG, GIF) and Videos (MP4, MOV, AVI)</p>
                    
                    <input type="file" id="mediaFile" name="mediaFile" multiple
                           class="hidden">
                </div>
                
                <!-- Selected files list -->
                <div id="fileList" class="mb-4 max-h-40 overflow-y-auto hidden">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">Selected Files:</h4>
                    <ul id="selectedFiles" class="text-sm text-gray-600"></ul>
                </div>
                
                <!-- Resume uploads section (hidden by default) -->
                <div id="resumeUploadContainer" class="mb-4 hidden">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">Resume Previous Upload:</h4>
                    <div id="resumableUploads" class="text-sm text-gray-600">
                        <p>Checking for resumable uploads...</p>
                    </div>
                </div>
                
                <!-- Progress bar (hidden by default) -->
                <div id="uploadProgressContainer" class="mb-4 hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Upload Progress</label>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="uploadProgressBar" class="bg-green-600 h-4 rounded-full text-xs text-white text-center leading-4" style="width: 0%">0%</div>
                    </div>
                    <p id="uploadStatus" class="text-sm text-gray-600 mt-1">Preparing upload...</p>
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" id="uploadSubmitBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript to handle modal visibility and file uploads -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadModal = document.getElementById('uploadModal');
    const closeUploadModal = document.getElementById('closeUploadModal');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgressContainer = document.getElementById('uploadProgressContainer');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadSubmitBtn = document.getElementById('uploadSubmitBtn');
    const mediaFileInput = document.getElementById('mediaFile');
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const selectedFiles = document.getElementById('selectedFiles');
    const resumeUploadContainer = document.getElementById('resumeUploadContainer');
    const resumableUploads = document.getElementById('resumableUploads');
    const uploadIdField = document.getElementById('uploadIdField');
    
    // Check for session storage for resumable uploads when opening modal
    const checkForResumableUploads = () => {
      // Clear any existing content
      while (resumableUploads.firstChild) {
        resumableUploads.removeChild(resumableUploads.firstChild);
      }
      
      // Get all upload_ids from session storage
      let resumableFound = false;
      for (let i = 0; i < sessionStorage.length; i++) {
        const key = sessionStorage.key(i);
        if (key.startsWith('resumable_upload_')) {
          resumableFound = true;
          try {
            const uploadInfo = JSON.parse(sessionStorage.getItem(key));
            const uploadId = key.replace('resumable_upload_', '');
            
            // Check if this upload is still valid on the server
            fetch(`{{ url_for('get_resumable_upload_info', upload_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', uploadId))
              .then(response => response.json())
              .then(data => {
                if (data.success && data.can_resume) {
                  const uploadTime = new Date(data.timestamp * 1000).toLocaleString();
                  const resumeItem = document.createElement('div');
                  resumeItem.className = 'p-2 border rounded mb-2 flex justify-between items-center';
                  resumeItem.innerHTML = `
                    <div>
                      <strong>${data.filename}</strong>
                      <div class="text-xs text-gray-500">Started: ${uploadTime}</div>
                    </div>
                    <button class="resume-upload-btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
                            data-upload-id="${uploadId}" data-filename="${data.filename}">
                      Resume
                    </button>
                  `;
                  resumableUploads.appendChild(resumeItem);
                  
                  // Add click event for the resume button
                  resumeItem.querySelector('.resume-upload-btn').addEventListener('click', function() {
                    const uploadId = this.getAttribute('data-upload-id');
                    const filename = this.getAttribute('data-filename');
                    
                    // Set the upload ID in the form
                    uploadIdField.value = uploadId;
                    
                    // Update UI to show we're resuming
                    uploadStatus.textContent = `Resuming upload of ${filename}...`;
                    resumeUploadContainer.classList.add('hidden');
                    uploadProgressContainer.classList.remove('hidden');
                    
                    // Start the upload process (form will be submitted automatically)
                    uploadForm.dispatchEvent(new Event('submit'));
                  });
                } else {
                  // This upload is no longer valid on the server, remove from session storage
                  sessionStorage.removeItem(key);
                }
              })
              .catch(error => {
                console.error('Error checking resumable upload:', error);
                // Remove this item if we can't verify it
                sessionStorage.removeItem(key);
              });
          } catch (e) {
            console.error('Error parsing resumable upload info:', e);
            sessionStorage.removeItem(key);
          }
        }
      }
      
      if (resumableFound) {
        resumeUploadContainer.classList.remove('hidden');
      } else {
        resumeUploadContainer.classList.add('hidden');
      }
    };

    uploadBtn.addEventListener('click', function () {
      uploadModal.classList.remove('hidden');
      checkForResumableUploads();
    });

    closeUploadModal.addEventListener('click', function () {
      uploadModal.classList.add('hidden');
      resetUploadForm();
    });

    uploadModal.addEventListener('click', function (event) {
      if (event.target === uploadModal) {
        uploadModal.classList.add('hidden');
        resetUploadForm();
      }
    });
    
    // Function to reset the upload form state
    function resetUploadForm() {
      uploadForm.reset();
      uploadIdField.value = '';
      uploadProgressContainer.classList.add('hidden');
      resumeUploadContainer.classList.add('hidden');
      fileList.classList.add('hidden');
      uploadProgressBar.style.width = '0%';
      uploadProgressBar.textContent = '0%';
      uploadStatus.textContent = 'Preparing upload...';
      while (selectedFiles.firstChild) {
        selectedFiles.removeChild(selectedFiles.firstChild);
      }
    }
    
    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
      dropZone.classList.add('border-indigo-500');
      dropZone.classList.add('bg-indigo-50');
    }
    
    function unhighlight() {
      dropZone.classList.remove('border-indigo-500');
      dropZone.classList.remove('bg-indigo-50');
    }
    
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      mediaFileInput.files = files;
      updateFileList(files);
    }
    
    // Click on drop zone to select files
    dropZone.addEventListener('click', function() {
      mediaFileInput.click();
    });
    
    // Update file input label with selected filenames
    mediaFileInput.addEventListener('change', function() {
      updateFileList(this.files);
    });
    
    function updateFileList(files) {
      if (files && files.length > 0) {
        // Clear the file list first
        while (selectedFiles.firstChild) {
          selectedFiles.removeChild(selectedFiles.firstChild);
        }
        
        // Add each file to the list
        Array.from(files).forEach(file => {
          const listItem = document.createElement('li');
          listItem.className = 'flex justify-between items-center py-1';
          
          // Format file size
          const fileSize = formatFileSize(file.size);
          
          listItem.innerHTML = `
            <span>${file.name}</span>
            <span class="text-gray-500 text-xs">${fileSize}</span>
          `;
          selectedFiles.appendChild(listItem);
        });
        
        // Show the file list
        fileList.classList.remove('hidden');
      } else {
        fileList.classList.add('hidden');
      }
    }
    
    // Format file size in human-readable format
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Handle form submission for streaming upload
    uploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // If we're resuming an upload, we don't need to check for files
      if (!uploadIdField.value) {
        const fileInput = document.getElementById('mediaFile');
        const files = fileInput.files;
        
        if (!files || files.length === 0) {
          alert('Please select at least one file to upload');
          return;
        }
      }
      
      // Show progress bar
      uploadProgressContainer.classList.remove('hidden');
      resumeUploadContainer.classList.add('hidden');
      
      if (!uploadIdField.value) {
        // New upload
        uploadProgressBar.style.width = '0%';
        uploadProgressBar.textContent = '0%';
        uploadStatus.textContent = 'Starting upload...';
      }
      
      // Disable submit button during upload
      uploadSubmitBtn.disabled = true;
      uploadSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed');
      
      const folder_id = document.querySelector('input[name="folder_id"]').value;
      
      // Upload files sequentially
      let currentFileIndex = 0;
      let successCount = 0;
      let failCount = 0;
      let pausedCount = 0;
      
      function uploadNextFile() {
        // If we have a specific upload ID (resuming), skip the files loop
        if (uploadIdField.value) {
          startUpload(null, uploadIdField.value);
          return;
        }
        
        const files = document.getElementById('mediaFile').files;
        
        if (currentFileIndex >= files.length) {
          // All files have been processed
          if (failCount === 0 && pausedCount === 0) {
            uploadStatus.textContent = `Upload complete! Successfully uploaded ${successCount} file(s).`;
          } else if (pausedCount > 0) {
            uploadStatus.textContent = `Upload paused. ${successCount} complete, ${pausedCount} can be resumed.`;
          } else {
            uploadStatus.textContent = `Upload complete! ${successCount} file(s) uploaded, ${failCount} failed.`;
          }
          
          // Enable submit button
          uploadSubmitBtn.disabled = false;
          uploadSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          
          // If we had successful uploads, reload gallery after delay
          if (successCount > 0) {
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          }
          
          return;
        }
        
        const file = files[currentFileIndex];
        const totalFiles = files.length;
        
        // Update progress UI for new file
        uploadProgressBar.style.width = '0%';
        uploadProgressBar.textContent = '0%';
        uploadStatus.textContent = `Uploading file ${currentFileIndex + 1} of ${totalFiles}: ${file.name}`;
        
        startUpload(file);
      }
      
      function startUpload(file, existingUploadId = null) {
        // Create form data for this file
        const formData = new FormData();
        
        if (file) {
          formData.append('mediaFile', file);
        }
        
        formData.append('folder_id', folder_id);
        
        if (existingUploadId) {
          formData.append('upload_id', existingUploadId);
        }
        
        // Upload the file
        fetch('{{ url_for("upload_stream") }}', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Track progress for this file
            const uploadId = data.upload_id;
            let progressInterval = setInterval(() => {
              fetch(`{{ url_for("upload_progress_status", upload_id="PLACEHOLDER") }}`.replace('PLACEHOLDER', uploadId))
                .then(response => response.json())
                .then(progressData => {
                  if (progressData.success) {
                    const progress = progressData.progress;
                    uploadProgressBar.style.width = `${progress}%`;
                    uploadProgressBar.textContent = `${progress}%`;
                    
                    if (progress >= 100) {
                      // File completed
                      clearInterval(progressInterval);
                      successCount++;
                      
                      if (existingUploadId) {
                        // Clean up session storage for resumed upload
                        sessionStorage.removeItem(`resumable_upload_${existingUploadId}`);
                        
                        // Update UI
                        uploadStatus.textContent = 'Upload complete!';
                        
                        // Enable submit button
                        uploadSubmitBtn.disabled = false;
                        uploadSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        
                        // Reload gallery after short delay
                        setTimeout(() => {
                          window.location.reload();
                        }, 1500);
                      } else {
                        currentFileIndex++;
                        // Start the next file after a short delay
                        setTimeout(uploadNextFile, 500);
                      }
                    }
                  } else {
                    clearInterval(progressInterval);
                    
                    if (existingUploadId) {
                      uploadStatus.textContent = `Error with resumed upload: ${progressData.message || 'Unknown error'}`;
                      // Enable submit button
                      uploadSubmitBtn.disabled = false;
                      uploadSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                      uploadStatus.textContent = `Error with file ${currentFileIndex + 1}: ${progressData.message || 'Unknown error'}`;
                      failCount++;
                      currentFileIndex++;
                      // Continue with next file
                      setTimeout(uploadNextFile, 500);
                    }
                  }
                })
                .catch(error => {
                  clearInterval(progressInterval);
                  console.error('Error checking progress:', error);
                  
                  if (existingUploadId) {
                    uploadStatus.textContent = `Error tracking resumed upload progress`;
                    // Enable submit button
                    uploadSubmitBtn.disabled = false;
                    uploadSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                  } else {
                    uploadStatus.textContent = `Error with file ${currentFileIndex + 1}: Could not track progress`;
                    failCount++;
                    currentFileIndex++;
                    // Continue with next file
                    setTimeout(uploadNextFile, 500);
                  }
                });
            }, 1000);
          } else if (data.paused) {
            // Upload paused/interrupted but can be resumed
            const uploadId = data.upload_id;
            
            // Store the upload info in session storage
            const uploadInfo = {
              filename: file ? file.name : 'Resumed upload',
              uploadId: uploadId,
              timestamp: Date.now()
            };
            
            sessionStorage.setItem(`resumable_upload_${uploadId}`, JSON.stringify(uploadInfo));
            pausedCount++;
            
            if (existingUploadId) {
              uploadStatus.textContent = `Upload paused. You can resume later.`;
              // Enable submit button
              uploadSubmitBtn.disabled = false;
              uploadSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
              uploadStatus.textContent = `File ${currentFileIndex + 1} paused. Will resume later.`;
              currentFileIndex++;
              // Continue with next file
              setTimeout(uploadNextFile, 500);
            }
          } else {
            // Failed to start upload for this file
            if (existingUploadId) {
              uploadStatus.textContent = `Failed to resume upload: ${data.message || 'Unknown error'}`;
              // Enable submit button
              uploadSubmitBtn.disabled = false;
              uploadSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              // Remove from session storage since it's no longer valid
              sessionStorage.removeItem(`resumable_upload_${existingUploadId}`);
            } else {
              uploadStatus.textContent = `Failed to upload ${file.name}: ${data.message || 'Unknown error'}`;
              failCount++;
              currentFileIndex++;
              // Continue with next file
              setTimeout(uploadNextFile, 500);
            }
          }
        })
        .catch(error => {
          console.error('Upload error:', error);
          
          if (existingUploadId) {
            uploadStatus.textContent = `Error resuming upload`;
            // Enable submit button
            uploadSubmitBtn.disabled = false;
            uploadSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            uploadStatus.textContent = `Error uploading ${file.name}`;
            failCount++;
            currentFileIndex++;
            // Continue with next file
            setTimeout(uploadNextFile, 500);
          }
        });
      }
      
      // Start uploading the first file or resuming existing upload
      uploadNextFile();
    });
  });
</script>
{% endblock %}